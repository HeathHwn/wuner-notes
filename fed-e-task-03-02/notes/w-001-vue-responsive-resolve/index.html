<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Vue.js 源码剖析-响应式原理 | Study Notes</title>
  <meta name="generator" content="VuePress 1.5.2">
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement('script');
      hm.src = 'https://hm.baidu.com/hm.js?408fc8ae9e93287c6ac296cfac03abf8';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  
  <meta name="description" content="大前端学习笔记">
    <meta name="keywords" content="Study Notes,Wuner,Vue,前端学习笔记,函数式编程,Promise,ES6+,TypeScript,JS性能优化,cli,脚手架,自动化构建,yeoman,plop,gulp,grunt,ESModule,webpack,rollup,lint,vue-router,vue-observe,virtual-dom,虚拟dom,vue源码解析,vue响应式原理,vue虚拟dom,vue模板编译,vue组件化,vue状态管理(vuex),服务端渲染(ssr),nuxtJs,搭建SSR">
  <link rel="preload" href="/wuner-notes/assets/css/0.styles.c6185683.css" as="style"><link rel="preload" href="/wuner-notes/assets/js/app.a809ef8d.js" as="script"><link rel="preload" href="/wuner-notes/assets/js/3.aefe3dc3.js" as="script"><link rel="preload" href="/wuner-notes/assets/js/36.4630365c.js" as="script"><link rel="prefetch" href="/wuner-notes/assets/js/10.7976e91f.js"><link rel="prefetch" href="/wuner-notes/assets/js/100.83923d25.js"><link rel="prefetch" href="/wuner-notes/assets/js/101.a6e0c361.js"><link rel="prefetch" href="/wuner-notes/assets/js/102.0beac992.js"><link rel="prefetch" href="/wuner-notes/assets/js/103.16658d3e.js"><link rel="prefetch" href="/wuner-notes/assets/js/104.229f702d.js"><link rel="prefetch" href="/wuner-notes/assets/js/105.7603531e.js"><link rel="prefetch" href="/wuner-notes/assets/js/106.c6cf5520.js"><link rel="prefetch" href="/wuner-notes/assets/js/107.2ba933e2.js"><link rel="prefetch" href="/wuner-notes/assets/js/108.496ff2cc.js"><link rel="prefetch" href="/wuner-notes/assets/js/109.ca18a9f1.js"><link rel="prefetch" href="/wuner-notes/assets/js/11.589a46d9.js"><link rel="prefetch" href="/wuner-notes/assets/js/110.2b88f986.js"><link rel="prefetch" href="/wuner-notes/assets/js/111.dd51c5d3.js"><link rel="prefetch" href="/wuner-notes/assets/js/112.cb8f456b.js"><link rel="prefetch" href="/wuner-notes/assets/js/113.58fcd0cb.js"><link rel="prefetch" href="/wuner-notes/assets/js/114.417e806c.js"><link rel="prefetch" href="/wuner-notes/assets/js/115.9a08e21a.js"><link rel="prefetch" href="/wuner-notes/assets/js/116.5d825eec.js"><link rel="prefetch" href="/wuner-notes/assets/js/117.38ea656b.js"><link rel="prefetch" href="/wuner-notes/assets/js/118.87c529e3.js"><link rel="prefetch" href="/wuner-notes/assets/js/119.cdfe8073.js"><link rel="prefetch" href="/wuner-notes/assets/js/12.9624a54d.js"><link rel="prefetch" href="/wuner-notes/assets/js/120.0d746ec4.js"><link rel="prefetch" href="/wuner-notes/assets/js/121.e7060a35.js"><link rel="prefetch" href="/wuner-notes/assets/js/122.e996cc4d.js"><link rel="prefetch" href="/wuner-notes/assets/js/123.b36e6eda.js"><link rel="prefetch" href="/wuner-notes/assets/js/124.d9aeb609.js"><link rel="prefetch" href="/wuner-notes/assets/js/125.6defae1b.js"><link rel="prefetch" href="/wuner-notes/assets/js/126.abe18c38.js"><link rel="prefetch" href="/wuner-notes/assets/js/127.47e4c3b2.js"><link rel="prefetch" href="/wuner-notes/assets/js/128.e254e598.js"><link rel="prefetch" href="/wuner-notes/assets/js/129.4ed94512.js"><link rel="prefetch" href="/wuner-notes/assets/js/13.b0ee3a30.js"><link rel="prefetch" href="/wuner-notes/assets/js/130.b3464e80.js"><link rel="prefetch" href="/wuner-notes/assets/js/131.2bce54d8.js"><link rel="prefetch" href="/wuner-notes/assets/js/132.b0bfb318.js"><link rel="prefetch" href="/wuner-notes/assets/js/133.cb916b45.js"><link rel="prefetch" href="/wuner-notes/assets/js/134.7d5ddb19.js"><link rel="prefetch" href="/wuner-notes/assets/js/135.6a00dc80.js"><link rel="prefetch" href="/wuner-notes/assets/js/136.c2ea2fc5.js"><link rel="prefetch" href="/wuner-notes/assets/js/137.171fb43e.js"><link rel="prefetch" href="/wuner-notes/assets/js/138.786f6a60.js"><link rel="prefetch" href="/wuner-notes/assets/js/139.7ae403b4.js"><link rel="prefetch" href="/wuner-notes/assets/js/14.1af6ecbe.js"><link rel="prefetch" href="/wuner-notes/assets/js/140.954d2ef0.js"><link rel="prefetch" href="/wuner-notes/assets/js/141.cd3408c4.js"><link rel="prefetch" href="/wuner-notes/assets/js/142.ad396f45.js"><link rel="prefetch" href="/wuner-notes/assets/js/143.ab063f89.js"><link rel="prefetch" href="/wuner-notes/assets/js/144.856bcd6a.js"><link rel="prefetch" href="/wuner-notes/assets/js/145.19bfaf21.js"><link rel="prefetch" href="/wuner-notes/assets/js/146.b6678f3d.js"><link rel="prefetch" href="/wuner-notes/assets/js/147.da39d200.js"><link rel="prefetch" href="/wuner-notes/assets/js/148.981b6bc2.js"><link rel="prefetch" href="/wuner-notes/assets/js/149.1337b9fe.js"><link rel="prefetch" href="/wuner-notes/assets/js/15.3c8f9d88.js"><link rel="prefetch" href="/wuner-notes/assets/js/150.999602c2.js"><link rel="prefetch" href="/wuner-notes/assets/js/151.572bccdb.js"><link rel="prefetch" href="/wuner-notes/assets/js/152.0e7ed536.js"><link rel="prefetch" href="/wuner-notes/assets/js/153.fc7aeac7.js"><link rel="prefetch" href="/wuner-notes/assets/js/154.876cdbb3.js"><link rel="prefetch" href="/wuner-notes/assets/js/155.9dfa71b1.js"><link rel="prefetch" href="/wuner-notes/assets/js/156.fa741ec7.js"><link rel="prefetch" href="/wuner-notes/assets/js/157.b1dcaaaa.js"><link rel="prefetch" href="/wuner-notes/assets/js/158.4f490352.js"><link rel="prefetch" href="/wuner-notes/assets/js/159.7dd29e40.js"><link rel="prefetch" href="/wuner-notes/assets/js/16.ab5dc4e7.js"><link rel="prefetch" href="/wuner-notes/assets/js/160.a4f90644.js"><link rel="prefetch" href="/wuner-notes/assets/js/161.794517fd.js"><link rel="prefetch" href="/wuner-notes/assets/js/162.d0347e26.js"><link rel="prefetch" href="/wuner-notes/assets/js/163.f502d3d1.js"><link rel="prefetch" href="/wuner-notes/assets/js/164.113359c3.js"><link rel="prefetch" href="/wuner-notes/assets/js/165.a7822bda.js"><link rel="prefetch" href="/wuner-notes/assets/js/166.8f815d80.js"><link rel="prefetch" href="/wuner-notes/assets/js/167.61e24439.js"><link rel="prefetch" href="/wuner-notes/assets/js/168.1bb14bf5.js"><link rel="prefetch" href="/wuner-notes/assets/js/169.e687b540.js"><link rel="prefetch" href="/wuner-notes/assets/js/17.c3e4c1f9.js"><link rel="prefetch" href="/wuner-notes/assets/js/170.07a4d5fe.js"><link rel="prefetch" href="/wuner-notes/assets/js/171.0e91ed26.js"><link rel="prefetch" href="/wuner-notes/assets/js/172.41d0a29d.js"><link rel="prefetch" href="/wuner-notes/assets/js/173.475948b8.js"><link rel="prefetch" href="/wuner-notes/assets/js/174.4c10b74e.js"><link rel="prefetch" href="/wuner-notes/assets/js/175.84aff17f.js"><link rel="prefetch" href="/wuner-notes/assets/js/176.2ee0965b.js"><link rel="prefetch" href="/wuner-notes/assets/js/177.8cdb75b7.js"><link rel="prefetch" href="/wuner-notes/assets/js/178.91477146.js"><link rel="prefetch" href="/wuner-notes/assets/js/179.7752a28c.js"><link rel="prefetch" href="/wuner-notes/assets/js/18.edfeea1b.js"><link rel="prefetch" href="/wuner-notes/assets/js/180.89909185.js"><link rel="prefetch" href="/wuner-notes/assets/js/181.add38058.js"><link rel="prefetch" href="/wuner-notes/assets/js/182.0bf95f16.js"><link rel="prefetch" href="/wuner-notes/assets/js/183.ff153ecc.js"><link rel="prefetch" href="/wuner-notes/assets/js/184.17b3918d.js"><link rel="prefetch" href="/wuner-notes/assets/js/185.962d670d.js"><link rel="prefetch" href="/wuner-notes/assets/js/186.d6910993.js"><link rel="prefetch" href="/wuner-notes/assets/js/187.8a5ada85.js"><link rel="prefetch" href="/wuner-notes/assets/js/188.46b5e769.js"><link rel="prefetch" href="/wuner-notes/assets/js/189.82f44dd5.js"><link rel="prefetch" href="/wuner-notes/assets/js/19.9cc2a7b5.js"><link rel="prefetch" href="/wuner-notes/assets/js/190.6cc8372f.js"><link rel="prefetch" href="/wuner-notes/assets/js/191.a33bd656.js"><link rel="prefetch" href="/wuner-notes/assets/js/192.7a2d0346.js"><link rel="prefetch" href="/wuner-notes/assets/js/193.f6d1ebba.js"><link rel="prefetch" href="/wuner-notes/assets/js/194.3408c045.js"><link rel="prefetch" href="/wuner-notes/assets/js/195.ca57f871.js"><link rel="prefetch" href="/wuner-notes/assets/js/196.2f778353.js"><link rel="prefetch" href="/wuner-notes/assets/js/197.b89f9012.js"><link rel="prefetch" href="/wuner-notes/assets/js/198.6d10dc84.js"><link rel="prefetch" href="/wuner-notes/assets/js/20.f52d8f50.js"><link rel="prefetch" href="/wuner-notes/assets/js/21.181487df.js"><link rel="prefetch" href="/wuner-notes/assets/js/22.7e731743.js"><link rel="prefetch" href="/wuner-notes/assets/js/23.67776d25.js"><link rel="prefetch" href="/wuner-notes/assets/js/24.952f3da8.js"><link rel="prefetch" href="/wuner-notes/assets/js/25.041f0768.js"><link rel="prefetch" href="/wuner-notes/assets/js/26.a8936c58.js"><link rel="prefetch" href="/wuner-notes/assets/js/27.f75ebb6c.js"><link rel="prefetch" href="/wuner-notes/assets/js/28.0c8492a7.js"><link rel="prefetch" href="/wuner-notes/assets/js/29.a1c74893.js"><link rel="prefetch" href="/wuner-notes/assets/js/30.fd3b777a.js"><link rel="prefetch" href="/wuner-notes/assets/js/31.67cbb794.js"><link rel="prefetch" href="/wuner-notes/assets/js/32.281f8859.js"><link rel="prefetch" href="/wuner-notes/assets/js/33.0b9aa40c.js"><link rel="prefetch" href="/wuner-notes/assets/js/34.af735477.js"><link rel="prefetch" href="/wuner-notes/assets/js/35.8bf0fd87.js"><link rel="prefetch" href="/wuner-notes/assets/js/37.99381559.js"><link rel="prefetch" href="/wuner-notes/assets/js/38.803f8518.js"><link rel="prefetch" href="/wuner-notes/assets/js/39.0594b31e.js"><link rel="prefetch" href="/wuner-notes/assets/js/4.6d605efe.js"><link rel="prefetch" href="/wuner-notes/assets/js/40.2c974435.js"><link rel="prefetch" href="/wuner-notes/assets/js/41.152b0e60.js"><link rel="prefetch" href="/wuner-notes/assets/js/42.fa640ede.js"><link rel="prefetch" href="/wuner-notes/assets/js/43.d2e99ad9.js"><link rel="prefetch" href="/wuner-notes/assets/js/44.912850e7.js"><link rel="prefetch" href="/wuner-notes/assets/js/45.af340e8d.js"><link rel="prefetch" href="/wuner-notes/assets/js/46.2c893977.js"><link rel="prefetch" href="/wuner-notes/assets/js/47.17265f1a.js"><link rel="prefetch" href="/wuner-notes/assets/js/48.372cf11b.js"><link rel="prefetch" href="/wuner-notes/assets/js/49.ef1de019.js"><link rel="prefetch" href="/wuner-notes/assets/js/5.499729e8.js"><link rel="prefetch" href="/wuner-notes/assets/js/50.9fc862de.js"><link rel="prefetch" href="/wuner-notes/assets/js/51.9e3df210.js"><link rel="prefetch" href="/wuner-notes/assets/js/52.da2225f6.js"><link rel="prefetch" href="/wuner-notes/assets/js/53.d9f34217.js"><link rel="prefetch" href="/wuner-notes/assets/js/54.77a9fff9.js"><link rel="prefetch" href="/wuner-notes/assets/js/55.e606317e.js"><link rel="prefetch" href="/wuner-notes/assets/js/56.02bce45f.js"><link rel="prefetch" href="/wuner-notes/assets/js/57.6ad0ff97.js"><link rel="prefetch" href="/wuner-notes/assets/js/58.cd8e403d.js"><link rel="prefetch" href="/wuner-notes/assets/js/59.ddb0aa03.js"><link rel="prefetch" href="/wuner-notes/assets/js/6.50a8d784.js"><link rel="prefetch" href="/wuner-notes/assets/js/60.f1a2db78.js"><link rel="prefetch" href="/wuner-notes/assets/js/61.7b9056be.js"><link rel="prefetch" href="/wuner-notes/assets/js/62.cad0ce41.js"><link rel="prefetch" href="/wuner-notes/assets/js/63.76522648.js"><link rel="prefetch" href="/wuner-notes/assets/js/64.6c93bdcb.js"><link rel="prefetch" href="/wuner-notes/assets/js/65.71b0fd1a.js"><link rel="prefetch" href="/wuner-notes/assets/js/66.898de639.js"><link rel="prefetch" href="/wuner-notes/assets/js/67.f2ef50b9.js"><link rel="prefetch" href="/wuner-notes/assets/js/68.9fb2e4f9.js"><link rel="prefetch" href="/wuner-notes/assets/js/69.1443e812.js"><link rel="prefetch" href="/wuner-notes/assets/js/7.5d593870.js"><link rel="prefetch" href="/wuner-notes/assets/js/70.8383b983.js"><link rel="prefetch" href="/wuner-notes/assets/js/71.634c9345.js"><link rel="prefetch" href="/wuner-notes/assets/js/72.507e6f87.js"><link rel="prefetch" href="/wuner-notes/assets/js/73.807954f0.js"><link rel="prefetch" href="/wuner-notes/assets/js/74.9c23de88.js"><link rel="prefetch" href="/wuner-notes/assets/js/75.97c3d5e0.js"><link rel="prefetch" href="/wuner-notes/assets/js/76.201de7ca.js"><link rel="prefetch" href="/wuner-notes/assets/js/77.2c7ed4a5.js"><link rel="prefetch" href="/wuner-notes/assets/js/78.b08060f6.js"><link rel="prefetch" href="/wuner-notes/assets/js/79.068f88a5.js"><link rel="prefetch" href="/wuner-notes/assets/js/8.7e45c9f6.js"><link rel="prefetch" href="/wuner-notes/assets/js/80.67e71c37.js"><link rel="prefetch" href="/wuner-notes/assets/js/81.453ffa1d.js"><link rel="prefetch" href="/wuner-notes/assets/js/82.19d9b23e.js"><link rel="prefetch" href="/wuner-notes/assets/js/83.e28951a8.js"><link rel="prefetch" href="/wuner-notes/assets/js/84.acf83fd2.js"><link rel="prefetch" href="/wuner-notes/assets/js/85.a148175c.js"><link rel="prefetch" href="/wuner-notes/assets/js/86.29b224ad.js"><link rel="prefetch" href="/wuner-notes/assets/js/87.d0a3a990.js"><link rel="prefetch" href="/wuner-notes/assets/js/88.6dc2007c.js"><link rel="prefetch" href="/wuner-notes/assets/js/89.dce4546d.js"><link rel="prefetch" href="/wuner-notes/assets/js/9.dd4046db.js"><link rel="prefetch" href="/wuner-notes/assets/js/90.95e77eb4.js"><link rel="prefetch" href="/wuner-notes/assets/js/91.1c2421b2.js"><link rel="prefetch" href="/wuner-notes/assets/js/92.3a81c211.js"><link rel="prefetch" href="/wuner-notes/assets/js/93.5f6d6263.js"><link rel="prefetch" href="/wuner-notes/assets/js/94.8a9faaa2.js"><link rel="prefetch" href="/wuner-notes/assets/js/95.483f58d5.js"><link rel="prefetch" href="/wuner-notes/assets/js/96.e1fa253e.js"><link rel="prefetch" href="/wuner-notes/assets/js/97.4ee07616.js"><link rel="prefetch" href="/wuner-notes/assets/js/98.6728a5ee.js"><link rel="prefetch" href="/wuner-notes/assets/js/99.34ed8e76.js"><link rel="prefetch" href="/wuner-notes/assets/js/vendors~docsearch.529fd6da.js">
  <link rel="stylesheet" href="/wuner-notes/assets/css/0.styles.c6185683.css">
</head>
<body>
<div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/wuner-notes/" class="home-link router-link-active"><!----> <span class="site-name">Study Notes</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://blog.csdn.net/qq_32090185" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-01-01/notes/" class="nav-link">
  函数式编程与 JS 异步编程、手写 Promise
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-01-02/notes/" class="nav-link">
  ES 新特性与 TypeScript、JS 性能优化
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-02-01/notes/" class="nav-link">
  开发脚手架及封装自动化构建工作流
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-02-02/notes/" class="nav-link">
  模块化开发与规范化标准
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-01/notes/" class="nav-link">
  手写 Vue Router、手写响应式实现、虚拟 DOM 和 Diff 算法
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-02/notes/" class="nav-link router-link-active">
  Vue.js 源码分析（响应式、虚拟 DOM、模板编译和组件化）
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-03/notes/" class="nav-link">
  Vuex 数据流管理及Vue.js 服务端渲染（SSR）
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-04/notes/" class="nav-link">
  搭建自己的SSR、静态站点生成（SSG）及封装 Vue.js 组件库
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-05/notes/" class="nav-link">
  Vue.js 3.0 Composition APIs 及 3.0 原理剖析
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-06/notes/" class="nav-link">
  Vue.js + Vuex + TypeScript 实战项目开发与项目优化
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="题目" class="dropdown-title"><span class="title">题目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-01-01/" class="nav-link">
  函数式编程与 JS 异步编程、手写 Promise
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-01-02/" class="nav-link">
  ES 新特性与 TypeScript、JS 性能优化
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-02-01/" class="nav-link">
  开发脚手架及封装自动化构建工作流
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-02-02/" class="nav-link">
  模块化开发与规范化标准
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-01/" class="nav-link">
  手写 Vue Router、手写响应式实现、虚拟 DOM 和 Diff 算法
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-02/" class="nav-link router-link-active">
  Vue.js 源码分析（响应式、虚拟 DOM、模板编译和组件化）
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-03/" class="nav-link">
  Vuex 数据流管理及Vue.js 服务端渲染（SSR）
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-04/" class="nav-link">
  搭建自己的SSR、静态站点生成（SSG）及封装 Vue.js 组件库
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-05/" class="nav-link">
  Vue.js 3.0 Composition APIs 及 3.0 原理剖析
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-06/" class="nav-link">
  Vue.js + Vuex + TypeScript 实战项目开发与项目优化
</a></li></ul></div></div><div class="nav-item"><a href="/wuner-notes/interview-questions/w-001-js-base/" class="nav-link">
  面试题
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://blog.csdn.net/qq_32090185" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-01-01/notes/" class="nav-link">
  函数式编程与 JS 异步编程、手写 Promise
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-01-02/notes/" class="nav-link">
  ES 新特性与 TypeScript、JS 性能优化
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-02-01/notes/" class="nav-link">
  开发脚手架及封装自动化构建工作流
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-02-02/notes/" class="nav-link">
  模块化开发与规范化标准
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-01/notes/" class="nav-link">
  手写 Vue Router、手写响应式实现、虚拟 DOM 和 Diff 算法
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-02/notes/" class="nav-link router-link-active">
  Vue.js 源码分析（响应式、虚拟 DOM、模板编译和组件化）
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-03/notes/" class="nav-link">
  Vuex 数据流管理及Vue.js 服务端渲染（SSR）
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-04/notes/" class="nav-link">
  搭建自己的SSR、静态站点生成（SSG）及封装 Vue.js 组件库
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-05/notes/" class="nav-link">
  Vue.js 3.0 Composition APIs 及 3.0 原理剖析
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-06/notes/" class="nav-link">
  Vue.js + Vuex + TypeScript 实战项目开发与项目优化
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="题目" class="dropdown-title"><span class="title">题目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-01-01/" class="nav-link">
  函数式编程与 JS 异步编程、手写 Promise
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-01-02/" class="nav-link">
  ES 新特性与 TypeScript、JS 性能优化
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-02-01/" class="nav-link">
  开发脚手架及封装自动化构建工作流
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-02-02/" class="nav-link">
  模块化开发与规范化标准
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-01/" class="nav-link">
  手写 Vue Router、手写响应式实现、虚拟 DOM 和 Diff 算法
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-02/" class="nav-link router-link-active">
  Vue.js 源码分析（响应式、虚拟 DOM、模板编译和组件化）
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-03/" class="nav-link">
  Vuex 数据流管理及Vue.js 服务端渲染（SSR）
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-04/" class="nav-link">
  搭建自己的SSR、静态站点生成（SSG）及封装 Vue.js 组件库
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-05/" class="nav-link">
  Vue.js 3.0 Composition APIs 及 3.0 原理剖析
</a></li><li class="dropdown-item"><!----> <a href="/wuner-notes/fed-e-task-03-06/" class="nav-link">
  Vue.js + Vuex + TypeScript 实战项目开发与项目优化
</a></li></ul></div></div><div class="nav-item"><a href="/wuner-notes/interview-questions/w-001-js-base/" class="nav-link">
  面试题
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/wuner-notes/fed-e-task-03-02/notes/" aria-current="page" class="sidebar-link">Vue.js 源码分析（响应式、虚拟 DOM、模板编译和组件化）</a></li><li><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/" aria-current="page" class="active sidebar-link">Vue.js 源码剖析-响应式原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#响应式处理的入口" class="sidebar-link">响应式处理的入口</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#observer" class="sidebar-link">Observer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#对象响应式处理" class="sidebar-link">对象响应式处理</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#数组响应式处理" class="sidebar-link">数组响应式处理</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#dep-类" class="sidebar-link">Dep 类</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#watcher-类" class="sidebar-link">Watcher 类</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#哪些数组操作可以触发视图更新" class="sidebar-link">哪些数组操作可以触发视图更新</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#总结" class="sidebar-link">总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#实例方法-数据" class="sidebar-link">实例方法/数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#vue-set-target-propertyname-index-value" class="sidebar-link">Vue.set(target, propertyName/index, value)</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#vm-set-target-propertyname-index-value" class="sidebar-link">vm.\$set(target, propertyName/index, value)</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#源码分析" class="sidebar-link">源码分析</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#vue-delete-target-propertyname-index" class="sidebar-link">Vue.delete(target, propertyName/index)</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#vm-delete-target-propertyname-index" class="sidebar-link">vm.\$delete(target, propertyName/index)</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#源码分析-2" class="sidebar-link">源码分析</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#vm-watch-exporfn-callback-options" class="sidebar-link">vm.\$watch(expOrFn, callback, [options])</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#三种类型的-watcher-对象" class="sidebar-link">三种类型的 Watcher 对象</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#vue-nexttick-callback-context" class="sidebar-link">Vue.nextTick([callback, context])</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#vm-nexttick-callback" class="sidebar-link">vm.\$nextTick([callback])</a></li><li class="sidebar-sub-header"><a href="/wuner-notes/fed-e-task-03-02/notes/w-001-vue-responsive-resolve/#源码分析-3" class="sidebar-link">源码分析</a></li></ul></li></ul></li><li><a href="/wuner-notes/fed-e-task-03-02/notes/w-002-vue-virtual-dom-resolve/" class="sidebar-link">Vue.js 源码剖析-虚拟 DOM</a></li><li><a href="/wuner-notes/fed-e-task-03-02/notes/w-003-vue-compile-resolve/" class="sidebar-link">Vue.js 源码剖析-模板编译</a></li><li><a href="/wuner-notes/fed-e-task-03-02/notes/w-004-vue-component-resolve/" class="sidebar-link">Vue.js 源码剖析-组件化</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-js-源码剖析-响应式原理"><a href="#vue-js-源码剖析-响应式原理" class="header-anchor">#</a> Vue.js 源码剖析-响应式原理</h1> <h2 id="响应式处理的入口"><a href="#响应式处理的入口" class="header-anchor">#</a> 响应式处理的入口</h2> <ul><li><a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/instance/init.js" target="_blank" rel="noopener noreferrer">src/core/instance/init.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <ul><li>initState(vm) vm 状态的初始化</li> <li>初始化了 _data、_props、methods 等</li></ul></li> <li><a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/instance/state.js" target="_blank" rel="noopener noreferrer">src/core/instance/state.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* @flow */</span>

<span class="token keyword">import</span> <span class="token operator">...</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sharedPropertyDefinition <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Object<span class="token punctuation">,</span> sourceKey<span class="token operator">:</span> string<span class="token punctuation">,</span> key<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span>_watchers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token function">initProps</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token function">initMethods</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断options中是否存在data属性</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果存在data属性，则给其添加响应式</span>
    <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果不存在data属性，则给给vue对象，添加_data属性，初始化为空对象，并给其添加响应式</span>
    <span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token function">initComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initProps</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token operator">:</span> Component<span class="token punctuation">,</span> propsOptions<span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token comment">// 判断data是否是函数，如果是一个函数，则是组件中的data，将其this指向vue</span>
  <span class="token comment">// 不是函数，则判断是否存在。不存在则赋值为空对象</span>
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token operator">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 判断data是否是[object Object]，如果不是，则将data赋值为空对象</span>
  <span class="token comment">// 并在非production环境下，抛出警告</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">'data functions should return an object:\n'</span> <span class="token operator">+</span>
          <span class="token string">'https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function'</span><span class="token punctuation">,</span>
        vm<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// proxy data on instance</span>
  <span class="token comment">// 获取data的所有key值</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token keyword">const</span> methods <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods<span class="token punctuation">;</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 在非production环境下，判断是否与methods里的方法存在同名，存在则抛出警告</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>methods<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; has already been defined as a data property.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          vm<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 在非production环境下，判断是否与props里的属性存在同名，存在则抛出警告</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The data property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is already declared as a prop. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Use prop default value instead.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          vm<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isReserved</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果key的第一个字符不是$或者_，为其设置代理</span>
      <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_data</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// observe data</span>
  <span class="token comment">// 将data转换为响应式数据</span>
  <span class="token comment">// true：告诉observe函数，其为根属性data</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token operator">:</span> Function<span class="token punctuation">,</span> vm<span class="token operator">:</span> Component</span><span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> computedWatcherOptions <span class="token operator">=</span> <span class="token punctuation">{</span> lazy<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">initComputed</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token operator">:</span> Component<span class="token punctuation">,</span> computed<span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineComputed</span><span class="token punctuation">(</span>
  <span class="token parameter">target<span class="token operator">:</span> any<span class="token punctuation">,</span>
  key<span class="token operator">:</span> string<span class="token punctuation">,</span>
  userDef<span class="token operator">:</span> Object <span class="token operator">|</span> Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createComputedGetter</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initMethods</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token operator">:</span> Component<span class="token punctuation">,</span> methods<span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initWatch</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token operator">:</span> Component<span class="token punctuation">,</span> watch<span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createWatcher</span><span class="token punctuation">(</span>
  <span class="token parameter">vm<span class="token operator">:</span> Component<span class="token punctuation">,</span>
  keyOrFn<span class="token operator">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>
  handler<span class="token operator">:</span> any<span class="token punctuation">,</span>
  options<span class="token operator">?</span><span class="token operator">:</span> Object<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">stateMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue<span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br></div></div><p><a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/observer/index.js" target="_blank" rel="noopener noreferrer">src/core/observer/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ul><li>observe(value, asRootData)</li> <li>负责为每一个 Object 类型的 value 创建一个 observer 实例</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* @flow */</span>

<span class="token keyword">import</span> <span class="token operator">...</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> arrayKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> observerState <span class="token operator">=</span> <span class="token punctuation">{</span>
  shouldConvert<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">protoAugment</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> src<span class="token operator">:</span> Object<span class="token punctuation">,</span> keys<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token comment">/* istanbul ignore next */</span>
<span class="token keyword">function</span> <span class="token function">copyAugment</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Object<span class="token punctuation">,</span> src<span class="token operator">:</span> Object<span class="token punctuation">,</span> keys<span class="token operator">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token comment">/**
 * Attempt to create an observer instance for a value,
 * returns the new observer if successfully observed,
 * or the existing observer if the value already has one.
 */</span>
<span class="token comment">// 如果不存在观察者实例，则创建观察者实例，并返回</span>
<span class="token comment">// 存在，则直接返回现有的观察者实例</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> any<span class="token punctuation">,</span> asRootData<span class="token operator">:</span> <span class="token operator">?</span>boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> Observer <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果value不是一个对象或者value是一个虚拟dom，则不往下执行，即不需为其转换为响应式数据</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> value <span class="token keyword">instanceof</span> <span class="token class-name">VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> ob<span class="token operator">:</span> Observer <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果value中存在__ob__属性，并且__ob__是Observer，则直接将value.__ob__赋值给ob</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__ob__ <span class="token keyword">instanceof</span> <span class="token class-name">Observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ob <span class="token operator">=</span> value<span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
    observerState<span class="token punctuation">.</span>shouldConvert <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>value<span class="token punctuation">.</span>_isVue
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// observerState.shouldConvert为true</span>
    <span class="token comment">// 并且当前是浏览器环境</span>
    <span class="token comment">// 并且value是一个数组或者是'[object Object]'</span>
    <span class="token comment">// 并且value是可扩展的（可以在它上面添加新的属性）</span>
    <span class="token comment">// 并且value不是Vue实例</span>
    <span class="token comment">// 创建一个Observer对象，并赋值给ob</span>
    ob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果处理的是根数据并且存在ob，则ob.vmCount++</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>asRootData <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ob<span class="token punctuation">.</span>vmCount<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ob<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span>
  <span class="token parameter">obj<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  key<span class="token operator">:</span> string<span class="token punctuation">,</span>
  val<span class="token operator">:</span> any<span class="token punctuation">,</span>
  customSetter<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>
  shallow<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> Object<span class="token punctuation">,</span> key<span class="token operator">:</span> any<span class="token punctuation">,</span> val<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> Object<span class="token punctuation">,</span> key<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">dependArray</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h2 id="observer"><a href="#observer" class="header-anchor">#</a> Observer</h2> <p><a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/observer/index.js" target="_blank" rel="noopener noreferrer">src/core/observer/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ul><li>Observer 类
<ul><li>constructor()方法，初始化数据，并改变数组当前对象的原型属性</li> <li>walk()方法为对象做响应式处理</li> <li>observeArray()方法为数组做响应式处理</li></ul></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  <span class="token comment">// 数据对象</span>
  value<span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token comment">// 依赖对象</span>
  dep<span class="token operator">:</span> Dep<span class="token punctuation">;</span>
  <span class="token comment">// 实例计数器</span>
  <span class="token comment">// 以该对象在根$data的vms数</span>
  vmCount<span class="token operator">:</span> number<span class="token punctuation">;</span> <span class="token comment">// number of vms that has this object as root $data</span>

  <span class="token comment">// 构造函数，初始化数据</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 将实例挂载到观察对象的__ob__属性</span>
    <span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果观察对象是一个数组，将数组转换为响应式数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> augment <span class="token operator">=</span> hasProto
        <span class="token operator">?</span> protoAugment <span class="token comment">// 改变数组当前对象的原型属性</span>
        <span class="token operator">:</span> copyAugment<span class="token punctuation">;</span> <span class="token comment">// 改变数组当前对象的原型属性</span>
      <span class="token comment">// arrayKeys是对象的所有自身属性的属性名组成的数组</span>
      <span class="token function">augment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 为数组中的每一个对象元素创建一个observer实例</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 遍历对象中的每一个属性，转换成getter/setter</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Walk through each property and convert them into
   * getter/setters. This method should only be called when
   * value type is Object.
   */</span>
  <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取对象里的所有属性</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历每一个属性，设置为响应式数据</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> obj<span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Observe a list of Array items.
   */</span>
  <span class="token function">observeArray</span><span class="token punctuation">(</span><span class="token parameter">items<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h3 id="对象响应式处理"><a href="#对象响应式处理" class="header-anchor">#</a> 对象响应式处理</h3> <ul><li>defineReactive
<ul><li>为一个对象定义一个响应式的属性，每一个属性对应一个 dep 对象</li> <li>如果该属性的值是对象，继续调用 observe</li> <li>如果给属性赋的新值是一个对象，继续调用 observe</li> <li>如果数据更新发送通知</li></ul></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 在对象上定义响应式属性</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span>
  <span class="token parameter">obj<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  key<span class="token operator">:</span> string<span class="token punctuation">,</span>
  val<span class="token operator">:</span> any<span class="token punctuation">,</span>
  customSetter<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>
  shallow<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建依赖对象实例，其作用是为当前属性(key)收集依赖</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取obj对象的属性描述符</span>
  <span class="token keyword">const</span> property <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 当且仅当该属性的 configurable 键值为 true 时</span>
  <span class="token comment">// 该属性的描述符才能够被改变，同时该属性也能从对应的对象上被删除。</span>
  <span class="token comment">// 如果存在属性描述符，并且configurable为false，即不可被转换为响应式数据，则不继续往下执行</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>configurable <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// cater for pre-defined getter/setters</span>
  <span class="token comment">// 提供预定义的存取器函数</span>
  <span class="token keyword">const</span> getter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>get<span class="token punctuation">;</span>
  <span class="token keyword">const</span> setter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>set<span class="token punctuation">;</span>

  <span class="token comment">// 当shallow为false或者不存在时</span>
  <span class="token comment">// observe会判断val是否是递归观察子对象</span>
  <span class="token comment">// 并将对象属性都转换为getter/setter，返回子观察对象</span>
  <span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 当且仅当该属性的 enumerable 键值为 true 时，该属性才会出现在对象的枚举属性中。</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果存在用户设置的getter，将getter的this指向obj，并赋值给value</span>
      <span class="token comment">// 否则直接将传入的val赋值给value</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>
      <span class="token comment">// 如果存在当前依赖目标，即watcher对象，则建立依赖</span>
      <span class="token comment">// 在src/core/observer/index.js中的mountComponent方法，创建了watcher对象</span>
      <span class="token comment">// 在watcher对象的构造函数中，创建了Dep.target</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 为当前属性收集依赖</span>
        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果存在子观察对象，则建立子对象的依赖关系</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 为当前子对象收集依赖</span>
          childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 如果value是数组，则特殊处理收集数组对象依赖</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 返回属性值</span>
      <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>
      <span class="token comment">// 如果新值等于旧值或者新值和旧值都为NaN，则不继续往下执行</span>
      <span class="token comment">/* eslint-disable no-self-compare */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果传入customSetter参数时，并且在非production环境时，调用customSetter方法</span>
      <span class="token comment">/* eslint-enable no-self-compare */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> customSetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果存在用户设置的setter，则将setter的this指向obj，并将newVal传入</span>
      <span class="token comment">// 否则直接newVal赋值给val</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 当shallow为false或者不存在时</span>
      <span class="token comment">// observe会判断newVal是否是是递归观察子对象，返回子观察对象</span>
      childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 派发更新(发布更新通知)</span>
      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><h3 id="数组响应式处理"><a href="#数组响应式处理" class="header-anchor">#</a> 数组响应式处理</h3> <p>在 observer 构造函数中</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 如果观察对象是一个数组，将数组转换为响应式数据</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> augment <span class="token operator">=</span> hasProto
    <span class="token operator">?</span> protoAugment <span class="token comment">// 改变数组当前对象的原型属性</span>
    <span class="token operator">:</span> copyAugment<span class="token punctuation">;</span> <span class="token comment">// 改变数组当前对象的原型属性</span>
  <span class="token comment">// arrayKeys是对象的所有自身属性的属性名组成的数组</span>
  <span class="token function">augment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 为数组中的每一个对象元素创建一个observer实例</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 遍历对象中的每一个属性，转换成getter/setter</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>改变数组当前对象的原型属性</li></ul> <p><a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/observer/array.js" target="_blank" rel="noopener noreferrer">src/core/observer/array.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/*
 * not type checking this file because flow doesn't play well with
 * dynamically accessing methods on Array prototype
 */</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> def <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> arrayProto <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
<span class="token comment">// 使用数组的原型创建一个新的对象</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>arrayProto<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Intercept mutating methods and emit events
 */</span>
<span class="token comment">// 修改数组元素的方法</span>
<span class="token punctuation">[</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token string">'pop'</span><span class="token punctuation">,</span> <span class="token string">'shift'</span><span class="token punctuation">,</span> <span class="token string">'unshift'</span><span class="token punctuation">,</span> <span class="token string">'splice'</span><span class="token punctuation">,</span> <span class="token string">'sort'</span><span class="token punctuation">,</span> <span class="token string">'reverse'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// cache original method</span>
    <span class="token comment">// 缓存数组的原方法</span>
    <span class="token keyword">const</span> original <span class="token operator">=</span> arrayProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用Object.defineProperty()方法，重写数组的方法</span>
    <span class="token function">def</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">mutator</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行原数组的原方法，并改变其this指向</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取数组对象的__ob__属性</span>
      <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
      <span class="token comment">// 获取数组新增的元素</span>
      <span class="token keyword">let</span> inserted<span class="token punctuation">;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token operator">:</span>
          inserted <span class="token operator">=</span> args<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token operator">:</span>
          inserted <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果存在新增元素，重新遍历数组元素设置为响应式数据</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>inserted<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// notify change</span>
      <span class="token comment">// 调用数组的ob对象发送更新通知</span>
      ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h3 id="dep-类"><a href="#dep-类" class="header-anchor">#</a> Dep 类</h3> <ol><li>在 defineReactive() 的 getter 中创建 dep 对象，当存在 Dep.target , 调用 dep.depend()</li> <li>dep.depend() 内部调用 Dep.target.addDep(this)，也就是 watcher 的 addDep() 方法，它内部最终调用 dep.addSub(this)，把订阅者（Watcher）添加到 dep 的 subs 数组中，当数据变化的时候调用 watcher 对象的 update() 方法</li> <li>什么时候设置的 Dep.target? 通过简单的案例调试观察。调用 mountComponent() 方法的时候，创建了渲染 watcher 对象，执行 watcher 中的 get() 方法</li> <li>get() 方法内部调用 pushTarget(this)，把当前 Dep.target = watcher，同时把当前 watcher 入栈，因为有父子组件嵌套的时候先把父组件对应的 watcher 入栈，再去处理子组件的 watcher，子组件的处理完毕后，再把父组件对应的 watcher 出栈，继续操作</li> <li>Dep.target 用来存放目前正在使用的 watcher。全局唯一，并且一次也只能有一个 watcher 被使用</li></ol> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* @flow */</span>

<span class="token keyword">import</span> type Watcher <span class="token keyword">from</span> <span class="token string">'./watcher'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> remove <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * A dep is an observable that can have multiple
 * directives subscribing to it.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token comment">// 静态属性，Watcher对象</span>
  <span class="token keyword">static</span> target<span class="token operator">:</span> <span class="token operator">?</span>Watcher<span class="token punctuation">;</span>
  <span class="token comment">// dep实例id</span>
  id<span class="token operator">:</span> number<span class="token punctuation">;</span>
  <span class="token comment">// dep实例对应的Watcher对象/订阅者数组</span>
  subs<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Watcher<span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token comment">// 构造函数，初始化数据</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 添加新的订阅者Watcher对象</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub<span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 移除订阅者Watcher对象</span>
  <span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token parameter">sub<span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">,</span> sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将观察对象和Watcher对象建立依赖</span>
  <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果存在target，则把dep对象添加到watcher的依赖中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 发布通知</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// stabilize the subscriber list first</span>
    <span class="token comment">// 克隆数组</span>
    <span class="token keyword">const</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用每个订阅者的update方法实现更新</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Dep.target 用来存放目前正在使用的watcher</span>
<span class="token comment">// 全局唯一，并且一次也只能有一个watcher被使用</span>
<span class="token comment">// the current target watcher being evaluated.</span>
<span class="token comment">// this is globally unique because there could be only one</span>
<span class="token comment">// watcher being evaluated at any time.</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> targetStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 入栈并将当前 watcher 赋值给Dep.target</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token parameter">_target<span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 每一个组件都有一个mountComponent函数</span>
  <span class="token comment">// mountComponent函数创建了watcher对象</span>
  <span class="token comment">// 所以每一个组件对应一个watcher对象</span>
  <span class="token comment">// 如果A组件嵌套B组件，当我们渲染A组件时，发现存在子组件，则先渲染子组件，将A组件渲染挂起</span>
  <span class="token comment">// 所以这里需要将A组件的Dep.target入栈</span>
  <span class="token comment">// 当子组件渲染结束后，将其弹出栈，并继续执行A组件渲染</span>
  <span class="token comment">// 总结：</span>
  <span class="token comment">// 父子组件嵌套的时候先把父组件对应的watcher入栈，再去处理子组件的watcher。</span>
  <span class="token comment">// 子组件处理完毕后，再把父组件对应的watcher出栈，继续操作</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> _target<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 出栈操作</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div><h3 id="watcher-类"><a href="#watcher-类" class="header-anchor">#</a> Watcher 类</h3> <ul><li>Watcher 分为三种，Computed Watcher、用户 Watcher (侦听器)、渲染 Watcher</li> <li>什么时候渲染 Watcher？在 <a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/instance/lifecycle.js" target="_blank" rel="noopener noreferrer">src/core/instance/lifecycle.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中的 mountComponent 方法中创建</li> <li><a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/observer/watcher.js" target="_blank" rel="noopener noreferrer">Watcher<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的构造函数初始化，处理 expOrFn （渲染 watcher 和侦听器处理不同）</li> <li>调用 this.get() ，它里面调用 pushTarget() 方法，接下来执行 this.getter.call(vm, vm) （对于渲染 watcher 调用 updateComponent），如果是用户 watcher 会获取属性的值（触发 get 操作）</li> <li>当数据更新的时候，dep 中调用 notify() 方法，notify() 中调用 watcher 的 update() 方法</li> <li>update() 中调用 queueWatcher()</li> <li>queueWatcher() 是一个核心方法，去除重复操作，调用 flushSchedulerQueue() 刷新队列并执行 watcher</li> <li>flushSchedulerQueue() 中对 watcher 排序，遍历所有 watcher ，如果存在 before，触发生命周期的钩子函数 beforeUpdate，执行 watcher.run()，它内部调用 this.get()，然后调用 this.cb() (渲染 watcher 的 cb 是 noop)</li></ul> <h3 id="哪些数组操作可以触发视图更新"><a href="#哪些数组操作可以触发视图更新" class="header-anchor">#</a> 哪些数组操作可以触发视图更新</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    arr<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在浏览器控制台分别执行下面的代码</span>
<span class="token comment">// 会更新视图</span>
<span class="token comment">// vm.arr.push(8)</span>
<span class="token comment">// 数据已改变，但不会更新视图</span>
<span class="token comment">// vm.arr[0] = 100</span>
<span class="token comment">// 将数组清空，也不会更新视图</span>
<span class="token comment">// vm.arr.length = 0</span>
<span class="token comment">// 将数组第一位删除，并重新赋值为100，这时会更新视图</span>
<span class="token comment">// vm.arr.splice(0,1,100)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p><img src="/wuner-notes/assets/img/1.b11b2d80.png" alt="note"></p> <h2 id="实例方法-数据"><a href="#实例方法-数据" class="header-anchor">#</a> 实例方法/数据</h2> <h3 id="vue-set-target-propertyname-index-value"><a href="#vue-set-target-propertyname-index-value" class="header-anchor">#</a> Vue.set(target, propertyName/index, value)</h3> <ul><li><p>参数：</p> <ul><li>{Object | Array} target</li> <li>{string | number} propertyName/index</li> <li>{any} value</li></ul></li> <li><p>返回值：设置的值。</p></li> <li><p>用法：</p> <p>向响应式对象中添加一个 property，并确保这个新 property 同样是响应式的，且触发视图更新。它必须用于向响应式对象上添加新 property，因为 Vue 无法探测普通的新增 property (比如 this.myObject.newProperty = 'hi')</p></li></ul> <blockquote><p>注意对象不能是 Vue 实例，或者 Vue 实例的根数据对象。</p></blockquote> <ul><li>示例</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>Vue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="vm-set-target-propertyname-index-value"><a href="#vm-set-target-propertyname-index-value" class="header-anchor">#</a> vm.$set(target, propertyName/index, value)</h3> <ul><li><p>参数：</p> <ul><li>{Object | Array} target</li> <li>{string | number} propertyName/index</li> <li>{any} value</li></ul></li> <li><p>返回值：设置的值。</p></li> <li><p>用法：</p> <p>这是全局 Vue.set 的别名。</p></li> <li><p>示例</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>vm<span class="token punctuation">.</span>$<span class="token keyword">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="源码分析"><a href="#源码分析" class="header-anchor">#</a> 源码分析</h3> <ul><li><p>Vue.set()</p> <p>在 <a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/global-api/index.js" target="_blank" rel="noopener noreferrer">src/core/global-api/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中定义</p></li> <li><p>vm.$set()</p> <p>在 <a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/instance/index.js" target="_blank" rel="noopener noreferrer">src/core/instance/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中的引用了在 <a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/instance/state.js" target="_blank" rel="noopener noreferrer">src/core/instance/state.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中的 stateMixin 方法，该方法定义了$set</p></li> <li><p>上诉两个方法都指向 <a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/observer/index.js" target="_blank" rel="noopener noreferrer">src/core/observer/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中的 set()方法</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> Object<span class="token punctuation">,</span> key<span class="token operator">:</span> any<span class="token punctuation">,</span> val<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
  <span class="token comment">// 如果目标是数组，并且key 是合法的索引</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isValidArrayIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过Math.max返回最大值，并赋值给target.length</span>
    target<span class="token punctuation">.</span>length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>length<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过 splice 对key位置的元素进行替换</span>
    <span class="token comment">// splice 在 src/core/observer/array.js中进行了响应式的处理</span>
    target<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果target中已存在key属性，则直接赋值</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 获取 target 中的 observer 对象</span>
  <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
  <span class="token comment">// 如果target是vue实例或者是$data，则直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>_isVue <span class="token operator">||</span> <span class="token punctuation">(</span>ob <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">.</span>vmCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">'Avoid adding reactive properties to a Vue instance or its root $data '</span> <span class="token operator">+</span>
          <span class="token string">'at runtime - declare it upfront in the data option.'</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果不存在ob，那么target 不是一个响应式对象，则直接赋值并返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
    <span class="token keyword">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 把 key 设置为响应式属性</span>
  <span class="token function">defineReactive</span><span class="token punctuation">(</span>ob<span class="token punctuation">.</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 发送更新通知</span>
  ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="vue-delete-target-propertyname-index"><a href="#vue-delete-target-propertyname-index" class="header-anchor">#</a> Vue.delete(target, propertyName/index)</h3> <ul><li><p>参数：</p> <ul><li>{Object | Array} target</li> <li>{string | number} propertyName/index</li></ul></li></ul> <blockquote><p>仅在 2.2.0+ 版本中支持 Array + index 用法。</p></blockquote> <ul><li><p>用法：</p> <p>删除对象的 property。如果对象是响应式的，确保删除能触发更新视图。这个方法主要用于避开 Vue 不能检测到 property 被删除的限制，但是你应该很少会使用它。</p></li></ul> <blockquote><p>在 2.2.0+ 中同样支持在数组上工作。</p></blockquote> <blockquote><p>目标对象不能是一个 Vue 实例或 Vue 实例的根数据对象。</p></blockquote> <h3 id="vm-delete-target-propertyname-index"><a href="#vm-delete-target-propertyname-index" class="header-anchor">#</a> vm.$delete(target, propertyName/index)</h3> <ul><li><p>参数：</p> <ul><li>{Object | Array} target</li> <li>{string | number} propertyName/index</li></ul></li> <li><p>用法：</p> <p>这是全局 Vue.delete 的别名。</p></li></ul> <h3 id="源码分析-2"><a href="#源码分析-2" class="header-anchor">#</a> 源码分析</h3> <ul><li><p>Vue.delete()</p> <p>在 <a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/global-api/index.js" target="_blank" rel="noopener noreferrer">src/core/global-api/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中定义</p></li> <li><p>vm.$delete()</p> <p>在 <a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/instance/index.js" target="_blank" rel="noopener noreferrer">src/core/instance/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中的引用了在 <a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/instance/state.js" target="_blank" rel="noopener noreferrer">src/core/instance/state.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中的 stateMixin 方法，该方法定义了$delete</p></li> <li><p>上诉两个方法都指向 <a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/observer/index.js" target="_blank" rel="noopener noreferrer">src/core/observer/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中的 del()方法</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> Object<span class="token punctuation">,</span> key<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果目标是数组，并且key 是合法的索引</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isValidArrayIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过 splice 对key位置的元素进行删除</span>
    <span class="token comment">// splice 在 src/core/observer/array.js中进行了响应式的处理</span>
    target<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 获取 target 中的 observer 对象</span>
  <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>__ob__<span class="token punctuation">;</span>
  <span class="token comment">// 如果target是vue实例或者是$data，则直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>_isVue <span class="token operator">||</span> <span class="token punctuation">(</span>ob <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">.</span>vmCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">'Avoid deleting properties on a Vue instance or its root $data '</span> <span class="token operator">+</span>
          <span class="token string">'- just set it to null.'</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果target不存在key属性，则直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 删除target的key属性</span>
  <span class="token keyword">delete</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果不存在ob，那么target 不是一个响应式对象，则直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 发送更新通知</span>
  ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="vm-watch-exporfn-callback-options"><a href="#vm-watch-exporfn-callback-options" class="header-anchor">#</a> <a href="https://cn.vuejs.org/v2/api/#vm-watch" target="_blank" rel="noopener noreferrer">vm.$watch(expOrFn, callback, [options])<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h3> <ul><li><p>功能</p> <ul><li>观察 Vue 实例变化的一个表达式或计算属性函数。回调函数得到的参数为新值和旧值。表达式只接受监督的键路径。对于更复杂的表达式，用一个函数取代。</li></ul></li> <li><p>参数</p> <ul><li><p>{string | Function} expOrFn：要监视的 $data 中的属性，可以是表达式或函数</p></li> <li><p>{Function | Object} callback：数据变化后执行的函数</p> <ul><li><p>函数：回调函数</p></li> <li><p>对象：具有 handler 属性(字符串或者函数)，如果该属性为字符串则 methods 中相应的定义</p></li></ul></li> <li><p>{Object} [options]：可选的选项</p> <ul><li><p>{boolean} deep：布尔类型，深度监听</p></li> <li><p>{boolean} immediate：布尔类型，是否立即执行一次回调函数</p></li></ul></li> <li><p>返回值：{Function} unwatch</p></li></ul> <blockquote><p>注意：在变更 (不是替换) 对象或数组时，旧值将与新值相同，因为它们的引用指向同一个对象/数组。Vue 不会保留变更之前值的副本。</p></blockquote></li> <li><p>示例</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token punctuation">{</span>
    a<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    b<span class="token operator">:</span> <span class="token string">'2'</span><span class="token punctuation">,</span>
    msg<span class="token operator">:</span> <span class="token string">'Hello Vue'</span><span class="token punctuation">,</span>
    user<span class="token operator">:</span> <span class="token punctuation">{</span>
      firstName<span class="token operator">:</span> <span class="token string">'诸葛'</span><span class="token punctuation">,</span>
      lastName<span class="token operator">:</span> <span class="token string">'亮'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// expOrFn 是表达式</span>
vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'user.firstName'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// expOrFn 是函数</span>
vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>b<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// deep 是 true，消耗性能</span>
vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>
  <span class="token string">'user'</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 此时的 newVal 是 user 对象</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal <span class="token operator">===</span> vm<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    deep<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// immediate 是 true</span>
vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>
  <span class="token string">'msg'</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="三种类型的-watcher-对象"><a href="#三种类型的-watcher-对象" class="header-anchor">#</a> 三种类型的 Watcher 对象</h3> <ul><li><p>没有静态方法，因为 $watch 方法中要使用 Vue 的实例</p></li> <li><p>Watcher 分三种：计算属性 Watcher、用户 Watcher (侦听器)、渲染 Watcher</p></li> <li><p>创建顺序：计算属性 Watcher、用户 Watcher (侦听器)、渲染 Watcher</p></li> <li><p>源码分析</p> <ul><li><a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/instance/state.js" target="_blank" rel="noopener noreferrer">src/core/instance/state.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$watch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
    <span class="token parameter">expOrFn<span class="token operator">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>
    cb<span class="token operator">:</span> any<span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token operator">:</span> Object</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
    <span class="token comment">// 获取 Vue 实例 this</span>
    <span class="token keyword">const</span> vm<span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 cb 是对象，则执行 createWatcher</span>
      <span class="token keyword">return</span> <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// 标记为用户 watcher</span>
    options<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// 创建用户 watcher 对象</span>
    <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// immediate 如果为 true，则立即执行一次 cb 回调，把this指向vue，并且当前值传入</span>
      <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> watcher<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回取消监听的方法</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unwatchFn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="vue-nexttick-callback-context"><a href="#vue-nexttick-callback-context" class="header-anchor">#</a> Vue.nextTick([callback, context])</h3> <ul><li><p>参数：</p></li> <li><p>{Function} [callback]</p></li> <li><p>{Object} [context]</p></li> <li><p>用法：</p> <p>在下次 DOM 更新循环结束之后执行延迟回调。在修改数据之后立即使用这个方法，获取更新后的 DOM。</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 修改数据</span>
vm<span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token string">'Hello'</span><span class="token punctuation">;</span>
<span class="token comment">// DOM 还没有更新</span>
Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// DOM 更新了</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 作为一个 Promise 使用 (2.1.0 起新增，详见接下来的提示)</span>
Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// DOM 更新了</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p>2.1.0 起新增：如果没有提供回调且在支持 Promise 的环境中，则返回一个 Promise。请注意 Vue 不自带 Promise 的 polyfill，所以如果你的目标浏览器不原生支持 Promise (IE：你们都看我干嘛)，你得自己提供 polyfill。</p></blockquote> <ul><li>参考：<a href="https://cn.vuejs.org/v2/guide/reactivity.html#%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0%E9%98%9F%E5%88%97" target="_blank" rel="noopener noreferrer">异步更新队列<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="vm-nexttick-callback"><a href="#vm-nexttick-callback" class="header-anchor">#</a> vm.$nextTick([callback])</h3> <ul><li><p>参数：</p> <ul><li>{Function} [callback]</li></ul></li> <li><p>用法：</p> <p>将回调延迟到下次 DOM 更新循环之后执行。在修改数据之后立即使用它，然后等待 DOM 更新。它跟全局方法 Vue.nextTick 一样，不同的是回调的 this 自动绑定到调用它的实例上。</p> <blockquote><p>2.1.0 起新增：如果没有提供回调且在支持 Promise 的环境中，则返回一个 Promise。请注意 Vue 不自带 Promise 的 polyfill，所以如果你的目标浏览器不是原生支持 Promise (IE：你们都看我干嘛)，你得自行 polyfill。</p></blockquote></li> <li><p>示例</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function-variable function">example</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 修改数据</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">'changed'</span><span class="token punctuation">;</span>
      <span class="token comment">// DOM 还没有更新</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// DOM 现在更新了</span>
        <span class="token comment">// `this` 绑定到当前实例</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>参考：<a href="https://cn.vuejs.org/v2/guide/reactivity.html#%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0%E9%98%9F%E5%88%97" target="_blank" rel="noopener noreferrer">异步更新队列<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="源码分析-3"><a href="#源码分析-3" class="header-anchor">#</a> 源码分析</h3> <p>在 <a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/instance/index.js" target="_blank" rel="noopener noreferrer">src/core/instance/index.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中调用 <a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/instance/render.js" target="_blank" rel="noopener noreferrer">src/core/instance/render.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中的 renderMixin 方法</p> <ul><li>手动调用 vm.$nextTick()</li> <li>在 Watcher 的 queueWatcher 中执行 nextTick()</li> <li><a href="https://gitee.com/Wuner/vue-resovle/blob/master/src/core/util/env.js" target="_blank" rel="noopener noreferrer">src/core/util/env.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> nextTick <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> timerFunc<span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">nextTickHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 克隆回调函数数组</span>
    <span class="token keyword">const</span> copies <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将callbacks数组置为空数组</span>
    callbacks<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历执行回调函数数组中的每一个回调函数</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> copies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      copies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// An asynchronous deferring mechanism.</span>
  <span class="token comment">// In pre 2.4, we used to use microtasks (Promise/MutationObserver)</span>
  <span class="token comment">// but microtasks actually has too high a priority and fires in between</span>
  <span class="token comment">// supposedly sequential events (e.g. #4521, #6690) or even between</span>
  <span class="token comment">// bubbling of the same event (#6566). Technically setImmediate should be</span>
  <span class="token comment">// the ideal choice, but it's not available everywhere; and the only polyfill</span>
  <span class="token comment">// that consistently queues the callback after all DOM events triggered in the</span>
  <span class="token comment">// same loop is by using MessageChannel.</span>
  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> setImmediate <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNative</span><span class="token punctuation">(</span>setImmediate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setImmediate</span><span class="token punctuation">(</span>nextTickHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token keyword">typeof</span> MessageChannel <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span><span class="token function">isNative</span><span class="token punctuation">(</span>MessageChannel<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token comment">// PhantomJS</span>
      MessageChannel<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object MessageChannelConstructor]'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> port <span class="token operator">=</span> channel<span class="token punctuation">.</span>port2<span class="token punctuation">;</span>
    channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> nextTickHandler<span class="token punctuation">;</span>
    <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNative</span><span class="token punctuation">(</span>Promise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* istanbul ignore next */</span>
    <span class="token comment">// use microtask in non-DOM environments, e.g. Weex</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>nextTickHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// fallback to setTimeout</span>
    <span class="token function-variable function">timerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span>nextTickHandler<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">queueNextTick</span><span class="token punctuation">(</span><span class="token parameter">cb<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> ctx<span class="token operator">?</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> _resolve<span class="token punctuation">;</span>
    <span class="token comment">// 把 cb 加上异常处理存入 callbacks 数组中</span>
    callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果存在cb</span>
          <span class="token comment">// 将cb的this指向ctx，并调用 cb()</span>
          <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> <span class="token string">'nextTick'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_resolve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">timerFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// $flow-disable-line</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 返回 promise 对象</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        _resolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/wuner-notes/fed-e-task-03-02/notes/" class="prev router-link-active">
        Vue.js 源码分析（响应式、虚拟 DOM、模板编译和组件化）
      </a></span> <span class="next"><a href="/wuner-notes/fed-e-task-03-02/notes/w-002-vue-virtual-dom-resolve/">
        Vue.js 源码剖析-虚拟 DOM
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
<script src="/wuner-notes/assets/js/app.a809ef8d.js" defer></script><script src="/wuner-notes/assets/js/3.aefe3dc3.js" defer></script><script src="/wuner-notes/assets/js/36.4630365c.js" defer></script>
</body>
</html>
